## **ToyC 语言文法解析**

ToyC 语言是 C 语言的一个简化子集，专为编译课程实践设计，其源文件扩展名为 `.tc`。它省略了数组、指针、I/O、前向声明、多文件编译等高级特性，语法结构更为简单。ToyC 源文件可以被 C 编译器编译并执行，结果与等效的 C 代码一致。

### **2.1 ToyC 语言的文法**

以下是 ToyC 语言的文法规则，其中 `CompUnit` 是开始符号:

- **编译单元 (CompUnit)**
  - `CompUnit → FuncDef+` (表示一个或多个函数定义)
- **语句 (Stmt)**
  - `Stmt → Block` (语句块)
  - `∣ “;”` (空语句)
  - `∣ Expr “;”` (表达式语句)
  - `∣ ID “=” Expr “;”` (变量赋值)
  - `∣ “int” ID “=” Expr “;”` (变量声明及初始化)
  - `∣ “if” “(” Expr “)” Stmt (“else” Stmt)?` (if-else 条件分支)
  - `∣ “while” “(” Expr “)” Stmt` (while 循环)
  - `∣ “break” “;”` (break 语句)
  - `∣ “continue” “;”` (continue 语句)
  - `∣ “return” “;”` (无返回值 return 语句)
  - `∣ “return” Expr？ “;”` (带返回值的 return 语句)
- **语句块 (Block)**
  - `Block → “{” Stmt* “}”` (由大括号包围的零个或多个语句序列)
- **函数定义 (FuncDef)**
  - `FuncDef → (“int” ∣ “void”) ID “(” (Param (“,” Param)*)? “)” Block` (包含返回类型、函数名、可选的参数列表和函数体)
- **形参 (Param)**
  - `Param → “int” ID` (表示一个整型参数及其名称)
- **表达式 (Expr)**
  - `Expr → LOrExpr` (表达式的最高优先级是逻辑或表达式)
- **逻辑或表达式 (LOrExpr)**
  - `LOrExpr → LAndExpr ∣ LOrExpr “||” LAndExpr` (左结合，包含 `||` 运算符)
- **逻辑与表达式 (LAndExpr)**
  - `LAndExpr → RelExpr ∣ LAndExpr “&&” RelExpr` (左结合，包含 `&&` 运算符)
- **关系表达式 (RelExpr)**
  - `RelExpr → AddExpr`
  - `∣ RelExpr (“<” ∣ “>” ∣ “<=” ∣ “>=” ∣ “==” ∣ “!=”) AddExpr` (左结合，包含关系运算符)
- **加减表达式 (AddExpr)**
  - `AddExpr → MulExpr`
  - `∣ AddExpr (“+” ∣ “-”) MulExpr` (左结合，包含加减运算符)
- **乘除模表达式 (MulExpr)**
  - `MulExpr → UnaryExpr`
  - `∣ MulExpr (“*” ∣ “/” ∣ “%”) UnaryExpr` (左结合，包含乘除模运算符)
- **一元表达式 (UnaryExpr)**
  - `UnaryExpr → PrimaryExpr`
  - `∣ (“+” ∣ “-” ∣ “!”) UnaryExpr` (右结合，包含一元运算符)
- **基本表达式 (PrimaryExpr)**
  - `PrimaryExpr → ID` (标识符)
  - `∣ NUMBER` (数字字面量)
  - `∣ “(” Expr “)”` (带括号的表达式)
  - `∣ ID “(” (Expr (“,” Expr)*)? “)”` (函数调用)

### **2.2 ToyC 语言的终结符特征**

- **标识符 (ID)**
  - 识别符合 C 规范的标识符.
  - 其正则表达式为 `[_A-Za-z][_A-Za-z0-9]*`.
- **整数 (NUMBER)**
  - 识别十进制整数常量.
  - 其正则表达式为 `-?(0|[1-9][0-9]*)`.
- **空白字符和注释**
  - 编译器应忽略空白字符和注释.
  - 空白字符包括空格、制表符、换行符等.
  - 注释的规范与 C 语言一致:
    - 单行注释以 `//` 开始，到最近的换行符前结束.
    - 多行注释以 `/*` 开始，以最近的 `*/` 结束.

### **2.3 ToyC 语言的语义约束**

- **程序结构**
  - 程序必须包含一个名为 `main` 的函数作为入口点.
  - `main` 函数的参数列表必须为空，返回类型必须为 `int`.
- **函数**
  - ToyC 中的函数支持传入若干 `int` 类型的参数，返回值可以为 `int` 或 `void` 类型.
  - 函数只能声明在全局作用域中且名称唯一，不能声明在函数体内.
  - 函数不能作为值来存储、传递或运算.
  - 函数调用必须写在被调函数声明之后（支持函数内部调用自身）.
  - 返回类型为 `int` 的函数必须在每一条可能的执行路径上通过 `return` 语句返回一个 `int` 类型的值.
  - 返回类型为 `void` 的函数可以不包含 `return` 语句，如果包含，则不能有返回值.
- **语句**
  - ToyC 中的语句包括语句块、空语句、表达式语句、变量赋值、变量声明、if-else 条件分支、while 循环、`break`、`continue` 和 `return`.
  - 它们的语法和语义与 C 语言一致.
  - 没有返回值的函数调用表达式不能作为 `if/while` 条件或赋值语句的右值.
  - `break` 和 `continue` 只能出现在循环中.
- **变量声明**
  - ToyC 支持声明 32 位有符号整数 (`int`) 类型的局部变量.
  - 每个变量声明语句只声明一个变量，且必须带有初始化表达式.
  - 变量的使用必须发生在声明之后.
  - 变量的作用域规则与 C 语言一致:
    - 变量的生命周期从声明点开始，到所在作用域结束时结束.
    - 函数形参在函数体内可见.
    - 语句块 `Block` 会创建新的作用域.
    - 内层作用域会屏蔽外层作用域的同名变量.
- **表达式**
  - ToyC 支持逻辑运算、关系运算、算术运算、括号表达式、变量引用、字面值和函数调用等 C 语言中的常见表达式.
  - 运算符的优先级、结合性和计算规则等与 C 语言一致.
  - 逻辑与、逻辑或运算符遵循"短路计算"规则.
  - 非零视为"真"、零视为"假".
  - 除数不能为零.

**关于 `Stmt` 产生式中 `return` 语句的说明：**

根据最新文法，`return` 语句的产生式包括 `"return" ";"`（无返回值）和 `"return" Expr ";"`（带返回值）。这样既满足文法一致性，也符合语义约束中对 int 类型函数返回值的要求。
